version: '3.8'

services:
  rotator-grupos:
    image: rotator-grupos:latest

    environment:
      - PORT=3000
      - DATABASE_URL_FILE=/run/secrets/database_url
      - EVOLUTION_BASE_URL_FILE=/run/secrets/evolution_base_url
      - EVOLUTION_APIKEY_FILE=/run/secrets/evolution_apikey
      - INTERNAL_TOKEN_FILE=/run/secrets/internal_token

    secrets:
      - database_url
      - evolution_base_url
      - evolution_apikey
      - internal_token

    deploy:
      replicas: 1

      restart_policy:
        condition: on-failure

      placement:
        constraints:
          - node.role == manager

      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=eplay1987"
        - "traefik.http.routers.rotator-grupos.rule=Host(`rotator.descontinbom.com.br`)"
        - "traefik.http.routers.rotator-grupos.entrypoints=websecure"
        - "traefik.http.routers.rotator-grupos.tls=true"
        - "traefik.http.routers.rotator-grupos.tls.certresolver=letsencrypt"
        - "traefik.http.services.rotator-grupos.loadbalancer.server.port=3000"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    networks:
      - eplay1987

secrets:
  database_url:
    external: true
  evolution_base_url:
    external: true
  evolution_apikey:
    external: true
  internal_token:
    external: true

networks:
  eplay1987:
    external: true
